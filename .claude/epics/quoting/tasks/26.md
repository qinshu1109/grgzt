# [P0.6] 税费预留与打包项实现

id: 26
title: 税费/预留/打包项以明细行体现，计算与排序规范
priority: P0
estimate: 3番茄 (4小时)
status: todo
depends_on: [20]
parallel_with: [23]
module: pricing
ext_id:

## 目的/产出
实现税费、预留和打包项作为独立明细行的报价计算机制，支持灵活配置和规范排序。

## 实施步骤

1. quote_items表类型扩展
   - 新增type字段支持：feature/package/surcharge/contingency
   - 实现meta字段JSON格式存储（percent、formula等）
   - 添加order_index字段支持排序

2. 税费预留计算逻辑
   - 实现subtotal_core计算（feature+package小计）
   - 税费计算：surcharge = subtotal_core × tax_percent
   - 预留计算：contingency = subtotal_core × contingency_percent
   - 确保base_price不参与百分比计算

3. 打包项管理功能
   - 常见打包项模板（部署、验收、沟通等）
   - 打包项的添加/删除/编辑
   - 支持固定金额和百分比两种模式

4. 报价计算顺序优化
   - 明确计算顺序：feature → package → surcharge → contingency
   - 实现order_index排序机制
   - 确保三档价格计算基于正确的total值

## 验收标准

- ✅ quote_items支持4种类型，meta字段存储JSON格式
- ✅ 税费预留计算正确，base_price不参与百分比基数
- ✅ 打包项可正常添加和编辑
- ✅ 报价明细按正确顺序显示
- ✅ 三档价格计算结果准确
- ✅ 与现有报价功能兼容

## 约束/边界

**仅修改以下文件/模块**：
- main.js (报价计算逻辑)
- 数据库表结构（quote_items扩展字段）
- 相关的API和UI组件

**明确不修改**：
- 现有报价的核心计算公式
- quotes表的主结构
- 其他业务逻辑

## 依赖/并行

- **依赖**: 20(复杂度系数配置)
- **可并行**: 23(UI开发)

## 风险与回退

**可能风险**：
- 现有报价数据兼容性问题
- 计算顺序错误导致价格不准确
- JSON字段解析异常

**回退方式**：
- 保持向后兼容，现有数据继续有效
- 添加计算日志和验证步骤
- 异常时使用默认计算方式
