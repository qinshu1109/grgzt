# [P0.2] 虚拟线索占位实现

id: 22
title: 实现虚拟线索 PRD/<yyyy-MM-dd HH:mm>/<slug> 自动落库
priority: P0
estimate: 2番茄 (3小时)
status: todo
depends_on: []
parallel_with: [20, 24, 25]
module: storage
ext_id:

## 目的/产出
实现虚拟线索的自动创建和占位功能，确保quotes表lead_id非空约束得到满足，格式为PRD/<yyyy-MM-dd HH:mm>/<slug>。

## 实施步骤

1. 虚拟线索生成逻辑实现
   - 格式: PRD/<yyyy-MM-dd HH:mm>/<slug>
   - slug生成规则: 标题前8-12字符或hash前6位
   - 无标题时使用"untitled"

2. 数据库约束兼容性处理
   - 检查leads表client_name NOT NULL约束
   - 实现占位数据自动填充

3. 虚拟线索与报价关联逻辑
   - 在创建quote时自动创建虚拟线索
   - 确保lead_id引用有效
   - 虚拟线索不在UI中显示

4. 数据验证与测试
   - 测试各种PRD标题的slug生成
   - 验证虚拟线索创建和关联正确性
   - 确保不影响现有leads功能

## 验收标准

- ✅ 虚拟线索格式正确: PRD/2025-09-15 10:32/个人项目
- ✅ 自动创建leads记录，client_name字段符合格式
- ✅ quotes创建时自动关联虚拟线索，无数据库错误
- ✅ 虚拟线索不在现有Leads UI中显示
- ✅ slug生成稳定，无特殊字符问题
- ✅ 重启应用后虚拟线索数据保持

## 约束/边界

**仅修改以下文件/模块**：
- main.js (数据库操作，虚拟线索创建逻辑)
- 不修改任何UI相关文件
- 不改变现有leads业务逻辑

**明确不修改**：
- leads表结构（只插入数据）
- quotes表结构（只使用现有字段）
- 任何用户界面相关代码

## 依赖/并行

- **依赖**: 无，可独立执行
- **可并行**: 20(复杂度系数), 24(规则引擎), 25(词典维护)

## 风险与回退

**可能风险**：
- slug生成冲突（时间戳相同+标题相同）
- 数据库约束变更导致兼容性问题

**回退方式**：
- 在slug后追加随机字符避免冲突
- 如数据库约束问题，使用更宽松的占位值
- 保留现有quotes创建逻辑作为fallback
